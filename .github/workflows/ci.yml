name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          persist-credentials: false

      - name: Install Rust
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 20

      - name: Add wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Install Trunk
        run: cargo install trunk --locked

      - name: Install npm dependencies
        run: npm ci --ignore-scripts

      - name: Node dependency audit (production dependencies)
        run: npm audit --omit=dev --audit-level=high

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Rust dependency audit
        run: cargo audit

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Rust format check
        run: cargo fmt --check

      - name: Rust clippy (deny warnings)
        run: cargo clippy --locked -- -D warnings

      - name: Native build
        run: cargo build --locked

      - name: Rust smoke tests
        run: cargo test --locked

      - name: WASM bundle build
        run: trunk build app.html --release

      - name: Performance budget checks
        run: npm run perf:ci

      - name: Playwright E2E tests (functional)
        run: npx playwright test --grep-invert "visual regression"

      - name: Playwright visual regression (non-blocking)
        continue-on-error: true
        run: npm run e2e:visual
